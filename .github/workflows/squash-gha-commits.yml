name: ğŸ§¹ Squash GitHub Action Commits

on:
  schedule:
    - cron: "0 */4 * * *" # Every 4 hours
  workflow_dispatch:

jobs:
  squash:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Full history needed to squash

      - name: ğŸ”§ Setup Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ§  Get commits with [skip ci]
        id: find_commits
        run: |
          COMMITS=$(git log --pretty=format:"%H" --grep="\[skip ci\]" origin/master)
          echo "$COMMITS"
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: â— Skip if no matching commits
        if: steps.find_commits.outputs.commits == ''
        run: echo "No [skip ci] commits to squash."

      - name: ğŸ§¹ Squash [skip ci] commits
        if: steps.find_commits.outputs.commits != ''
        run: |
          COMMITS="${{ steps.find_commits.outputs.commits }}"
          FIRST_COMMIT=$(echo "$COMMITS" | tail -n 1)
          git checkout master
          git pull origin master

          git reset --soft "$FIRST_COMMIT^"
          git commit -m "ğŸ§¹ Squashed [skip ci] commits [bot-squash] [skip ci]"
          git push origin master --force
